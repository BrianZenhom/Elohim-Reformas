---
import Card from "../components/card.astro";
import Design from "../assets/design.svg";
import Construction from "../assets/construction.svg";
import Maintenance from "../assets/maintenance.svg";
---

<section class="services" id="services">
  <article class="services-content">
    <div class="services-title-sub">
      <h2>Servicios</h2>
      <p>
        Nuestras habilidades y experiencia nos permiten <br /> obtener los mejores
        resultados.
      </p>
    </div>
    <div class="services-cards">
      <Card
        title="Diseño"
        description="Creamos proyectos arquitectónicos únicos que se adaptan a tu estilo, necesidades y presupuesto."
        icon={Design}
        image="./diseno.webp"
      />
      <Card
        title="Construcción"
        description="Ejecutamos tu obra con materiales de calidad y profesionales expertos, desde los cimientos hasta los acabados."
        icon={Construction}
        image="./construccion.webp"
      />
      <Card
        title="Mantenimiento"
        description="Solucionamos filtraciones, arreglos eléctricos, pintura y más para mantener tu casa como nueva."
        icon={Maintenance}
        image="./mantenimiento.webp"
      />
    </div>
    <div class="services-clientes-satisfechos flex-version">
      <div class="services-clientes-satisfechos-content">
        <div class="services-clientes-satisfechos-content-text">
          <p>Absolutamente comprometidos</p>
          <div class="odometer services-number" id="odometer">
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
          </div>

          <p class="services-text-subtitle">Clientes satisfechos</p>
        </div>
      </div>

      <div class="services-line"></div>

      <div class="services-años-de-experiencia">
        <div class="services-clientes-satisfechos-content-text">
          <p>Experiencia que ofrece confianza</p>
          <div class="odometer services-number" id="odometer-experience">
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
            <div class="digit-column">
              <div class="digits">
                <div>0</div><div>1</div><div>2</div><div>3</div><div>4</div>
                <div>5</div><div>6</div><div>7</div><div>8</div><div>9</div>
              </div>
            </div>
          </div>
          <p class="services-text-subtitle">Proyectos completados</p>
        </div>
      </div>
    </div>
  </article>

  <style is:global>
    .services {
      min-height: 100dvh;
      padding-top: 10rem;
      background-color: #f5efe7;
      color: #1a3347;
      font-family:
        "Onest",
        system-ui,
        -apple-system,
        BlinkMacSystemFont,
        "Segoe UI",
        Roboto,
        Oxygen,
        Ubuntu,
        Cantarell,
        "Open Sans",
        "Helvetica Neue",
        sans-serif;
      font-size: 18px;
      font-weight: 500;
      letter-spacing: 1px;
      transition: all 0.1s ease-out;
    }
    .services-clientes-satisfechos-content-text p {
      text-align: left;
    }

    .services-años-de-experiencia {
      display: flex;
      justify-content: center;
      width: 337px;
    }
    .services-cards {
      display: flex;
      justify-content: center;
      gap: 2rem;
    }

    .services-title-sub {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 100%;
    }

    .services-title-sub h2 {
      font-weight: 600;
    }

    .services-title-sub p {
      text-wrap: balance;
      color: #929292;
    }

    .digits {
      color: #4a8fe7;
    }

    .flex-version {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 3rem;
    }

    .services-clientes-satisfechos-content {
      display: flex;
      justify-content: center;
    }

    .flex-version > :not(.services-line) {
      flex: 1 1 0;
      text-align: center;
    }

    .services-line {
      width: 1px;
      height: 200px;
      background: linear-gradient(#0000, #000, #0000) no-repeat center/2px 100%;
      margin: 0;
    }

    .services-text-subtitle {
      color: #929292;
      font-size: 14px;
      font-family: "Onest";
    }

    .services-clientes-satisfechos-content-text .services-text-subtitle {
      text-align: right;
    }

    .services-number {
      font-weight: 500;
      font-size: 124px;
      font-variant-numeric: tabular-nums;
    }

    .odometer {
      display: flex;
      font-size: 3em;
      border-radius: 8px;
      width: fit-content;
      margin: auto;
      font-size: clamp(24px, 10vw, 124px);
    }

    .digit-column {
      overflow: hidden;
      height: 1em;
      width: 1ch;
      position: relative;
    }

    .digits {
      display: flex;
      flex-direction: column;
      transition: transform 0.3s ease-out;
    }

    .digits > div {
      height: 1em;
      line-height: 1em;
    }

    /* make this global */
    @media (width <= 900px) {
      .services {
        padding-top: 2rem;
        padding-bottom: 2rem;
      }
      .services-title-sub h2 {
        font-size: 18px;
      }

      .services-title-sub p {
        font-size: 14px;
        color: #929292;
      }

      .services-cards {
        flex-direction: column;
        gap: 2rem;
      }
      .services-años-de-experiencia {
        max-width: fit-content;
      }

      .services-clientes-satisfechos {
        gap: 1rem;
      }

      .card-content h3 {
        font-size: 18px;
      }

      .card-content p {
        font-size: 14px;
      }
      .services-content {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding-left: 1rem;
        padding-right: 1rem;
      }

      .services-clientes-satisfechos-content-text p {
        font-size: 12px;
        text-wrap: wrap;
        line-break: strict;
      }

      .services-line {
        height: 120px;
      }
    }
  </style>

  <script>
    let digitHeight = 0;

    const tickAudio = new Audio(
      "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAIA+AAACABAAZGF0YQAAAAA="
    );

    function playTick() {
      tickAudio.currentTime = 0;
      tickAudio.play().catch(() => {});
    }

    function updateDigitColumn(column: any, digit: any, spinning = false) {
      const digits = column.querySelector(".digits");
      requestAnimationFrame(() => {
        digits.style.transform = `translateY(-${digit * digitHeight}px)`;
        if (spinning) {
          digits.style.filter = "blur(1px)";
          digits.style.transition =
            "transform 0.3s ease-out, filter 0.3s ease-out";
        } else {
          digits.style.filter = "none";
          digits.style.transition =
            "transform 0.3s ease-out, filter 0.3s ease-out";
        }
        playTick();
      });
    }

    function renderNumber(num: any, container: any) {
      const str = num.toString().padStart(4, "0");
      const digits = str.split("");
      const columns = container.querySelectorAll(".digit-column");

      digits.forEach((digit: any, idx: any) => {
        updateDigitColumn(columns[idx], parseInt(digit), false);
      });
    }

    function animateDigitColumn(
      column: any,
      fromDigit: any,
      toDigit: any,
      spins = 1,
      delay = 0
    ) {
      const totalDigits = 10;
      const totalSteps = 60;
      const duration = 800 + spins * 150;
      const frameRate = duration / totalSteps;
      const easeOut = (t: any) => 1 - Math.pow(1 - t, 3);

      let frame = 0;
      let totalShift = spins * totalDigits + ((toDigit - fromDigit + 10) % 10);

      setTimeout(() => {
        const interval = setInterval(() => {
          const progress = frame / totalSteps;
          const eased = easeOut(progress);
          const current = Math.floor(fromDigit + eased * totalShift) % 10;

          updateDigitColumn(column, current, frame < totalSteps);

          if (frame > 0) playTick();

          frame++;
          if (frame > totalSteps) {
            updateDigitColumn(column, toDigit, false);
            clearInterval(interval);
          }
        }, frameRate);
      }, delay);
    }

    function animateOdometer(from: any, to: any, container: any) {
      const fromDigits = from.toString().padStart(4, "0").split("").map(Number);
      const toDigits = to.toString().padStart(4, "0").split("").map(Number);
      const columns = container.querySelectorAll(".digit-column");

      fromDigits.forEach((fromDigit: any, i: any) => {
        const toDigit = toDigits[i];
        const delay = i * 200; // stagger start time
        const spins = 4 - i; // lower digits spin more

        animateDigitColumn(columns[i], fromDigit, toDigit, spins, delay);
      });
    }

    function isInViewport(elem: any) {
      const rect = elem.getBoundingClientRect();
      return rect.top < window.innerHeight && rect.bottom >= 0;
    }

    const odometer1 = document.getElementById("odometer");
    const odometer2 = document.getElementById("odometer-experience");
    let hasAnimated = false;

    window.addEventListener("scroll", () => {
      if (
        !hasAnimated &&
        (isInViewport(odometer1) || isInViewport(odometer2))
      ) {
        hasAnimated = true;
        animateOdometer(1123, 1200, odometer1);
        animateOdometer(950, 1100, odometer2); // 0950
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      const firstDigit = document.querySelector(".digits > div");
      digitHeight = firstDigit?.getBoundingClientRect().height || 0;

      renderNumber(1123, odometer1);
      renderNumber(950, odometer2);
    });
  </script>
</section>
